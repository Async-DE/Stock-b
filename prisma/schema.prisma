generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  owner
  editor
  seller
}

model usuario {
  id Int @id @default(autoincrement())

  nombre      String
  usuario     String  @unique
  email_phone String  @unique
  password    String // hash bcrypt
  estado      Boolean @default(true)
  permisos    Rol     @default(seller)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditorias auditoria[]
  sesiones   sesion[]
}

model sesion {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  token      String   @unique
  revocado   Boolean  @default(false)
  createdAt  DateTime @default(now())

  usuario usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([token])
}

model ubicacion {
  id        Int      @id @default(autoincrement())
  nombre    String
  calle     String
  cp        String
  colonia   String
  celular   String
  createdAt DateTime @default(now())

  auditorias         auditoria[]
  ubicacione_almacen ubicacion_almacen[]
}

model ubicacion_almacen {
  id           Int @id @default(autoincrement())
  ubicacion_id Int

  codigo      String?
  tipo        String?
  descripcion String?
  createdAt   DateTime @default(now())

  ubicacion ubicacion @relation(fields: [ubicacion_id], references: [id], onDelete: Cascade)

  variantes variantes[]
}

model categorias {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique
  createdAt DateTime @default(now())

  subcategorias subcategorias[]
  auditorias    auditoria[]
}

model subcategorias {
  id               Int      @id @default(autoincrement())
  nombre           String
  ganancias_ventas Float    @default(0)
  valor_stock      Float    @default(0)
  createdAt        DateTime @default(now())

  categoriaId Int
  categoria   categorias @relation(fields: [categoriaId], references: [id])

  productos  productos[]
  auditorias auditoria[]
}

model productos {
  id             Int @id @default(autoincrement())
  subcategoriaId Int

  subcategoria subcategorias @relation(fields: [subcategoriaId], references: [id])

  createdAt DateTime @default(now())

  variantes  variantes[]
  auditorias auditoria[]
}

model fotos {
  id          Int @id @default(autoincrement())
  variante_id Int

  url String

  variante variantes @relation(fields: [variante_id], references: [id], onDelete: Cascade)
}

model variantes {
  id                   Int @id @default(autoincrement())
  producto_id          Int
  ubicacion_almacen_id Int

  nombre      String
  codigo      String
  color       String
  descripcion String
  cantidad    Float

  alto    Float? @default(0)
  ancho   Float? @default(0)
  largo   Float? @default(0)
  medidas String? @default("N/A")

  precio_publico     Float
  precio_contratista Float
  costo_compra       Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ganacia_publico     Float @default(0)
  ganacia_contratista Float @default(0)
  ganancias_stock     Float @default(0)
  valor_stock         Float @default(0)

  producto          productos         @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  ubicacion_almacen ubicacion_almacen @relation(fields: [ubicacion_almacen_id], references: [id], onDelete: SetNull)

  ventas     ventas[]
  auditorias auditoria[]
  fotos      fotos[]
}

model ventas {
  id               Int      @id @default(autoincrement())
  variante_id      Int
  cantidad         Int
  total_venta      Float
  fecha_venta      DateTime @default(now())
  nombre_cliente   String
  contacto_cliente String

  // Timestamp de la información del producto
  precio_publico     Float
  precio_contratista Float
  costo_compra       Float

  variante variantes? @relation(fields: [variante_id], references: [id])

  // Relación con costos extras
  costosExtras costosExtras[]
  auditorias   auditoria[]
}

model costosExtras {
  id        Int      @id @default(autoincrement())
  venta_id  Int
  motivo    String
  costo     Float
  createdAt DateTime @default(now())

  // Relación con ventas
  venta ventas @relation(fields: [venta_id], references: [id])
}

enum Accion {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VENTA
  AJUSTE_STOCK
}

model auditoria {
  id Int @id @default(autoincrement())

  usuario_id Int
  accion     Accion

  productoId Int?
  producto   productos? @relation(fields: [productoId], references: [id], map: "auditoria_producto_fkey")

  varianteId Int?
  variante   variantes? @relation(fields: [varianteId], references: [id], map: "auditoria_variante_fkey")

  ventaId Int?
  venta   ventas? @relation(fields: [ventaId], references: [id], map: "auditoria_venta_fkey")

  categoriaId Int?
  categoria   categorias? @relation(fields: [categoriaId], references: [id], map: "auditoria_categoria_fkey")

  subcategoriaId Int?
  subcategoria   subcategorias? @relation(fields: [subcategoriaId], references: [id], map: "auditoria_subcategoria_fkey")

  ubicacionId Int?
  ubicacion   ubicacion? @relation(fields: [ubicacionId], references: [id], map: "auditoria_ubicacion_fkey")

  createdAt DateTime @default(now())

  usuario usuario @relation(fields: [usuario_id], references: [id], map: "auditoria_usuario_fkey")

  @@index([usuario_id])
  @@index([productoId])
  @@index([varianteId])
  @@index([ventaId])
  @@index([categoriaId])
  @@index([subcategoriaId])
  @@index([ubicacionId])
}
