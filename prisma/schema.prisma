generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model usuario {
  id Int @id @default(autoincrement())

  nombre      String
  usuario     String  @unique
  email_phone String  @unique
  password    String // hash bcrypt
  estado      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditorias auditoria[]
  sesiones   sesion[]
}

model sesion {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  token      String   @unique
  revocado   Boolean  @default(false)
  createdAt  DateTime @default(now())

  usuario usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([token])
}

model ubicacion {
  id        Int      @id @default(autoincrement())
  nombre    String
  calle     String
  cp        String
  colonia   String
  celular   String
  createdAt DateTime @default(now())

  estantes   estantes[]
  auditorias auditoria[]
}

model niveles {
  id         Int @id @default(autoincrement())
  estantesId Int
  niveles    Int

  estantes estantes? @relation(fields: [estantesId], references: [id])

  variantes variantes[]
}

model estantes {
  id        Int      @id @default(autoincrement())
  Seccion   String
  pasillo   Int
  createdAt DateTime @default(now())

  ubicacion   ubicacion?  @relation(fields: [ubicacionId], references: [id], onDelete: SetNull)
  ubicacionId Int?
  auditorias  auditoria[]
  niveles     niveles[]
}

model categorias {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique
  createdAt DateTime @default(now())

  subcategorias subcategorias[]
  auditorias    auditoria[]
}

model subcategorias {
  id               Int      @id @default(autoincrement())
  nombre           String
  ganancias_ventas Float
  ganancias_stock  Float
  createdAt        DateTime @default(now())

  categoriaId Int
  categoria   categorias @relation(fields: [categoriaId], references: [id])

  productos  productos[]
  auditorias auditoria[]
}

model productos {
  id             Int  @id @default(autoincrement())
  subcategoriaId Int?

  subcategoria subcategorias? @relation(fields: [subcategoriaId], references: [id])

  createdAt DateTime @default(now())

  variantes  variantes[]
  auditorias auditoria[]
}

model variantes {
  id          Int @id @default(autoincrement())
  producto_id Int
  nivelesId   Int

  foto String

  nombre             String
  codigo             String
  color              String
  descripcion        String
  cantidad           Int
  medidas            String
  precio_publico     Float
  precio_contratista Float
  costo_compra       Float
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  ganacia_publico     Float @default(0)
  ganacia_contratista Float @default(0)
  
  ganancias_stock     Float @default(0)

  producto productos @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  niveles  niveles   @relation(fields: [nivelesId], references: [id], onDelete: Cascade)

  ventas     ventas[]
  auditorias auditoria[]
}

model ventas {
  id                 Int      @id @default(autoincrement())
  variante_id        Int
  cantidad           Int
  total_venta        Float
  fecha_venta        DateTime @default(now())
  nombre_cliente     String
  contacto_cliente   String

  // Timestamp de la información del producto
  precio_publico     Float
  precio_contratista Float
  costo_compra       Float

  variante variantes? @relation(fields: [variante_id], references: [id])

  // Relación con costos extras
  costosExtras costosExtras[]
  auditorias   auditoria[]
}

model costosExtras {
  id        Int      @id @default(autoincrement())
  venta_id  Int
  motivo    String
  costo     Float
  createdAt DateTime @default(now())

  // Relación con ventas
  venta ventas @relation(fields: [venta_id], references: [id])
}

enum Accion {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VENTA
  AJUSTE_STOCK
}

model auditoria {
  id Int @id @default(autoincrement())

  usuario_id Int
  accion     Accion

  productoId Int?
  producto   productos? @relation(fields: [productoId], references: [id], map: "auditoria_producto_fkey")

  varianteId Int?
  variante   variantes? @relation(fields: [varianteId], references: [id], map: "auditoria_variante_fkey")

  ventaId Int?
  venta   ventas? @relation(fields: [ventaId], references: [id], map: "auditoria_venta_fkey")

  estanteId Int?
  estante   estantes? @relation(fields: [estanteId], references: [id], map: "auditoria_estante_fkey")

  categoriaId Int?
  categoria   categorias? @relation(fields: [categoriaId], references: [id], map: "auditoria_categoria_fkey")

  subcategoriaId Int?
  subcategoria   subcategorias? @relation(fields: [subcategoriaId], references: [id], map: "auditoria_subcategoria_fkey")

  ubicacionId Int?
  ubicacion   ubicacion? @relation(fields: [ubicacionId], references: [id], map: "auditoria_ubicacion_fkey")

  createdAt DateTime @default(now())

  usuario usuario @relation(fields: [usuario_id], references: [id], map: "auditoria_usuario_fkey")

  @@index([usuario_id])
  @@index([productoId])
  @@index([varianteId])
  @@index([ventaId])
  @@index([estanteId])
  @@index([categoriaId])
  @@index([subcategoriaId])
  @@index([ubicacionId])
}
